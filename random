local SemiObfuscator = {}

local chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_"
math.randomseed(tick())

-- Configuraci칩n simple
local config = {
    enableStringEncoding = true,
    enableFunctionRenaming = true,
    enableJunkCode = false  -- Desactivar por ahora
}

-- Generar nombres aleatorios
local function generateRandomName(length)
    length = length or 8
    local name = ""
    for i = 1, length do
        local randIndex = math.random(1, #chars)
        name = name .. chars:sub(randIndex, randIndex)
    end
    return name
end

-- Codificaci칩n simple SIN bit32
local function simpleEncode(str)
    local encoded = ""
    local key = 142857  -- Key fija para simplificar
    
    for i = 1, #str do
        local charCode = str:byte(i)
        local encodedChar = (charCode ~ (key + i)) % 256  -- XOR simple
        encoded = encoded .. string.format("%02X", encodedChar)
    end
    return encoded
end

-- Decodificador simple
local function generateSimpleDecoder(encodedStrings)
    if not encodedStrings or #encodedStrings == 0 then
        return ""
    end
    
    local decoder = [[
local _S = {}
local function decode(s)
    local key = 142857
    local result = ""
    for i = 1, #s, 2 do
        local hex = s:sub(i, i+1)
        local num = tonumber(hex, 16)
        local charCode = (num ~ (key + (i+1)/2)) % 256
        result = result .. string.char(charCode)
    end
    return result
end
]]
    
    for i, encodedStr in ipairs(encodedStrings) do
        decoder = decoder .. "\n_S[" .. i .. "] = decode(\"" .. encodedStr .. "\")"
    end
    
    return decoder
end

-- Funci칩n principal SIMPLIFICADA
function SemiObfuscator.Obfuscate(code)
    local obfuscatedCode = code
    local encodedStrings = {}
    
    -- 1. Codificar strings simples
    if config.enableStringEncoding then
        local processedCode = obfuscatedCode
        local stringIndex = 1
        
        -- Buscar y codificar strings entre comillas dobles
        for quoted in processedCode:gmatch('"([^"]*)"') do
            if #quoted > 3 then  -- Solo strings largos
                local encoded = simpleEncode(quoted)
                encodedStrings[stringIndex] = encoded
                processedCode = processedCode:gsub(
                    '"' .. quoted:gsub("([^%w])", "%%%1") .. '"',
                    '_S[' .. stringIndex .. ']',
                    1
                )
                stringIndex = stringIndex + 1
            end
        end
        obfuscatedCode = processedCode
    end
    
    -- 2. Renombrar funciones b치sico
    if config.enableFunctionRenaming then
        local funcMap = {}
        
        -- Encontrar funciones locales
        for funcName in obfuscatedCode:gmatch("local%s+([%a_][%w_]*)%s*=%s*function") do
            if not funcMap[funcName] then
                funcMap[funcName] = generateRandomName()
            end
        end
        
        -- Reemplazar nombres
        for oldName, newName in pairs(funcMap) do
            obfuscatedCode = obfuscatedCode:gsub(oldName, newName)
        end
    end
    
    -- 3. Generar decodificador si hay strings codificados
    local decoder = ""
    if #encodedStrings > 0 then
        decoder = generateSimpleDecoder(encodedStrings)
    end
    
    -- 4. Combinar todo
    local finalCode = decoder
    if decoder ~= "" then
        finalCode = finalCode .. "\n\n" .. obfuscatedCode
    else
        finalCode = obfuscatedCode
    end
    
    return finalCode
end

function SemiObfuscator.Configure(newConfig)
    for k, v in pairs(newConfig) do
        config[k] = v
    end
end

return SemiObfuscator
